//
// Copyright (c) 2018 HÃ¥kan Edling
//
// This software may be modified and distributed under the terms
// of the MIT license.  See the LICENSE file for details.
// 
// http://github.com/piranhacms/piranha.core
// 

tinymce.PluginManager.add('piranhalink', function (editor) {
    function showDialog() {
        var win, data, dom = editor.dom, linkElm = editor.selection.getNode();
        var href, target, text;

        function pageDialog(e) {
            // Show modal
            $('#modalPage').modal('show');

            // Configure modal
            piranha.page.pageUrlId = win.find('#href')[0].$el[0].id;
        }

        function postDialog(e) {
            // Show modal
            $('#modalPost').modal('show');

            // Configure modal
            piranha.post.postUrlId = win.find('#href')[0].$el[0].id;
        }

        function mediaDialog(e) {
            // Show modal
            $('#modalMedia').modal('show');

            // Configure modal
            piranha.media.mediaUrlId = win.find('#href')[0].$el[0].id;
        }

        if (linkElm.nodeName !== 'A')
        {
            var parentElm = editor.dom.getParent(linkElm, 'a');
            if (parentElm && parentElm.nodeName == 'A')
                linkElm = parentElm;
        }

        href = dom.getAttrib(linkElm, 'href');
        target = dom.getAttrib(linkElm, 'target');
        text = linkElm.nodeName == "A" && !linkElm.getAttribute('data-mce-object') ? linkElm.innerHTML : editor.selection.getContent();
        var isText = true;
        // Partial html and not a fully selected anchor element
        if (/</.test(text) && (!/^<a [^>]+>[^<]+<\/a>$/.test(text) || text.indexOf('href=') == -1)) {
            isText = false;
        }

        if (linkElm.nodeName == "A" && !linkElm.getAttribute('data-mce-object')) {
            data = {
                href: href,
                target: target,
                text: text
            };
        } else {
            linkElm = null;

            data = {
                text: text
            };
        }

        var textCtrl;
        if (isText) {
            textCtrl = { name: 'text', type: 'textbox', label: 'Text to display' };
        }

        win = editor.windowManager.open({
            title: "Insert/edit link",
            data: data,
            body: [
                { 
                    type: 'container', 
                    label: 'Url', 
                    layout: 'flex',
                    direction: 'row', 
                    spacing: 5,
                    items: [
                        { name: 'href', type: 'textbox', autofocus: true, size: 27 },
                        { name: 'pagedialog', type: 'button', text: 'Select Page', onclick: pageDialog },
                        { name: 'postdialog', type: 'button', text: 'Select Post', onclick: postDialog },
                        { name: 'mediadialog', type: 'button', text: 'Select Media', onclick: mediaDialog }
                    ]
                },
				textCtrl,
                {
                    name: 'target', 
                    type: 'listbox', 
                    label: 'Target', 
                    'values': [
                        {text: 'None', value: ''},
                        {text: 'New window', value: '_blank'}
                    ]
                }
            ],
            onSubmit: function (e) {
                var data = e.data;

                if (linkElm) {
                    dom.setAttribs(linkElm, data);
                    dom.setHTML(linkElm, data.text ? data.text : text);
                } else {
                    editor.insertContent(dom.createHTML('a', data, data.text ? data.text : text));
                }
            }
        });
    }

    editor.addButton('piranhalink', {
        icon: 'link',
        tooltip: 'Insert/edit link',
        onclick: showDialog,
        stateSelector: 'a:not([data-mce-object])'
    });

    editor.addMenuItem('piranalink', {
        icon: 'link',
        text: 'Insert link',
        onclick: showDialog,
        context: 'insert',
        prependToContext: true
    });
});