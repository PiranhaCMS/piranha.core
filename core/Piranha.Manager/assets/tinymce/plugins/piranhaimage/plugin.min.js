//
// Copyright (c) 2013-2017 HÃ¥kan Edling
//
// This software may be modified and distributed under the terms
// of the MIT license.  See the LICENSE file for details.
// 
// http://github.com/piranhacms/piranha.core
// 

tinymce.PluginManager.add('piranhaimage', function (editor) {
    function showDialog() {
        var win, data, dom = editor.dom, imgElm = editor.selection.getNode();
        var src, width, height;

        function mediaDialog(e) {
            // Show modal
            $('#modalMedia').modal('show');

            // Configure modal
            piranha.media.mediaUrlId = win.find('#src')[0].$el[0].id;
        }

        width = dom.getAttrib(imgElm, 'width');
        height = dom.getAttrib(imgElm, 'height');
        src = dom.getAttrib(imgElm, 'src');

        if (src.startsWith('/')) {
            var components = src.split('/');
            var pos = 0;

            for (pos = 0; pos < components.length; pos++) {
                console.log('loop');
                if (components[pos] == 'media') {
                    break;
                }
                if (pos == (components.length - 1)) {
                    pos = -1;
                    break;
                }
            }

            if (pos != -1 && components.length > (2 + pos)) {
                if (components[2 + pos] != 'x') {
                    width = components[2 + pos];
                }
                if (components.length > (3 + pos)) {
                    height = components[3 + pos];
                }
                src = components.slice(0, 2 + pos).join('/');
            }
        }

        if (imgElm.nodeName == "IMG" && !imgElm.getAttribute('data-mce-object')) {
            data = {
                src: src,
                alt: dom.getAttrib(imgElm, 'alt'),
                width: width,
                height: height
            };
        } else {
            imgElm = null;
        }

        win = editor.windowManager.open({
            title: "Insert/edit image",
            data: data,
            body: [
                { 
                    type: 'container', 
                    label: 'Source', 
                    layout: 'flex',
                    direction: 'row', 
                    spacing: 5,
                    items: [
                        { name: 'src', type: 'textbox', autofocus: true, size: 27 },
                        { name: 'dialog', type: 'button', text: 'Browse', onclick: mediaDialog }
                    ]
                },
				{ name: 'alt', type: 'textbox', label: 'Image description' },
				{
				    type: 'container',
				    label: 'Dimensions',
				    layout: 'flex',
				    direction: 'row',
				    align: 'center',
				    spacing: 5,
				    items: [
						{ name: 'width', type: 'textbox', maxLength: 3, size: 3 },
						{ type: 'label', text: 'x' },
						{ name: 'height', type: 'textbox', maxLength: 3, size: 3 },
				    ]
				}
            ],
            onSubmit: function (e) {
                var data = e.data;

                if (imgElm) {
                    dom.setAttribs(imgElm, data);
                } else {
                    editor.insertContent(dom.createHTML('img', data));
                }
            }
        });
    }

    editor.addButton('piranhaimage', {
        icon: 'image',
        tooltip: 'Insert/edit image',
        onclick: showDialog,
        stateSelector: 'img:not([data-mce-object])'
    });

    editor.addMenuItem('piranhaimage', {
        icon: 'image',
        text: 'Insert image',
        onclick: showDialog,
        context: 'insert',
        prependToContext: true
    });
});